{% block form_login %}
  <form action="/login" method="posr" class="my-5">
    <div class="mb-3">
      <label for="inputLogin" class="form-label">Login</label>
      <span id="mistake-login" class="mistake"></span>
      <input name="login" type="text" class="form-control" id="inputLogin"
             aria-describedby="loginHelp" maxlength="50">
      <div id="loginHelp" class="form-text">Login must be one word and contain
        only letters and/or numbers
      </div>
    </div>
    <div class="mb-3">
      <label for="inputPassword" class="form-label">Password</label>
      <span id="mistake-pass" class="mistake"></span>
      <input type="password" id="inputPassword" class="form-control"
             aria-describedby="passwordHelpBlock" maxlength="20">
      <div id="passwordHelpBlock" class="form-text">
        Your password must be 8-20 characters long, contain letters and numbers,
        and must not contain spaces, special characters, or emoji.
      </div>
      <input type="hidden" name="action" value="login">
    </div>
    <button id="clear-form" type="text" class="btn btn-info">Clear</button>
    <button id="submit" type="submit" class="btn btn-primary ms-2">Login
    </button>
  </form>

  {# Temporary js #}
  <script type="text/javascript">
    $(window).on('load', function () {

      let mistake = 'This field cannot be empty';

      $('#submit').on('click', function (e) {
        e.preventDefault();

        let login = $('#inputLogin').val();
        if (!login) {
          mistakeAction('inputLogin', 'mistake-login', mistake);
          return false;
        }

        let loginTestA = /[^a-zA-Z0-9]/g.test(login);
        mistake = 'Illegal characters';
        if (loginTestA) {
          mistakeAction('inputLogin', 'mistake-login', mistake);
        }

        let pass = $('#inputPassword').val();
        if (!pass) {
          mistakeAction('inputPassword', 'mistake-pass', mistake);
          return false;
        }

        let passTestA = /[^a-zA-Z0-9]/g.test(pass);
        if (passTestA) {
          mistake = 'Illegal characters';
          mistakeAction('inputPassword', 'mistake-pass', mistake);
          return false;
        }

        $.ajax({
          url: '/api/',
          method: 'post',
          dataType: 'json',
          data: {'login': login, 'pass': pass, 'action': 'login'},
          success: function (data) {
            if (data.data.userinfo != false) {
              let userinfo = data.data.userinfo;
              $('#user-info').text(userinfo.name);
              $('#login-mess').html("Hello again " + userinfo.name + "!").addClass('show success-text');
              $.cookie('user', userinfo.id, {expires: 7});
              $('#nav-login').hide();
              $('#nav-logout').show();
              $('#nav-registration').hide();
              setTimeout(function () {
                window.location.href = '/chat';
              }, 3000);
            } else {
              $('#login-mess').html("Sorry, but there is no such user!!!");
              $('#login-mess').addClass('show mistake-text');
            }
            $('#inputLogin').val('');
            $('#inputPassword').val('');
          }
        });
      });

      $('#clear-form').on('click', function (e) {
        e.preventDefault();
        clearForm();
      });

      function clearForm() {
        $('#mistake-login, #login-mess')
          .html('')
          .removeClass('show mistake-text success-text');
      }

      function mistakeAction(toFocus, toMistake, mistake) {
        $('#' + toFocus).focus();
        $('#' + toMistake).text(mistake).addClass('show');
        setTimeout(function () {
          $('#' + toMistake).removeClass('show');
        }, 3000);
      }
    });
  </script>
{% endblock %}
